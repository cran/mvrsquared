<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Tommy Jones" />

<meta name="date" content="2023-07-14" />

<title>Getting Started With mvrsquared</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Getting Started With mvrsquared</h1>
<h4 class="author">Tommy Jones</h4>
<h4 class="date">2023-07-14</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Welcome to the <code>mvrsquared</code> package! This package does one
thing: calculate the <a href="https://en.wikipedia.org/wiki/Coefficient_of_determination">coefficient
of determination</a> or R-squared. However, this implementation is
different from what you may be familiar with. In addition to the
standard R-squared used frequently in linear regression,
<code>mvrsquared</code> calculates R-squared for multivariate outcomes.
(This is why there is an ‘mv’ in <code>mvrsquared</code>).</p>
<p><code>mvrsquared</code> implements R-squared based on a derivation in
<a href="https://arxiv.org/abs/1911.11061">this paper</a>. It’s the same
definition of R-squared you’re probably familiar with (<span class="math inline">\(1 - \frac{SSE}{SST}\)</span>) but generalized to
n-dimensions.</p>
<p>In the standard case, your outcome <span class="math inline">\(y\)</span> and prediction <span class="math inline">\(\hat{y}\)</span> are vectors. In other words, each
observation is a single number. This is fine if you are predicting a
single variable. But what if you are predicting multiple variables at
once? In that case, <span class="math inline">\(y\)</span> and <span class="math inline">\(\hat{y}\)</span> are matrices. This situation
occurs frequently in topic modeling or simultaneous equation
modeling.</p>
<p>Below are some examples of using <code>mvrsquared</code> for
calculating R-squared in the traditional context and for multivariate
outcomes.</p>
</div>
<div id="traditional-r-squared" class="section level1">
<h1>Traditional R-squared</h1>
<p>Below is a simple example comparing the R-squared calculated from a
linear model fit by <code>lm</code> in the <code>stats</code> package
and the R-squared calculated in the <code>mvrsquared</code> package.
(Spoiler alert: they’re identical.) Why do this? If
<code>mvrsquared</code> can’t get the same calculation, you probably
shouldn’t trust it. (Spoiler alert again: it can and you should.)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(mvrsquared)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">data</span>(mtcars)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># fit a linear model</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> cyl <span class="sc">+</span> disp <span class="sc">+</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co"># extract r-squared </span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>f_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(f)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>r2_lm <span class="ot">&lt;-</span> f_summary<span class="sc">$</span>r.squared</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>r2_lm</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#&gt; [1] 0.8486348</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="co"># calculate univariate r-squared using mvrsquared</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>r2_mv <span class="ot">&lt;-</span> <span class="fu">calc_rsquared</span>(<span class="at">y =</span> mtcars<span class="sc">$</span>mpg, <span class="at">yhat =</span> f<span class="sc">$</span>fitted.values)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>r2_mv</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="co">#&gt; [1] 0.8486348</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="co"># just to be 100% sure...</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>r2_lm <span class="sc">==</span> r2_mv</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>You can also calculate R-squared by passing your data and your linear
weights. (That’s probably less useful for univariate outcome models.
But, as you’ll see below, it’s very important for latent variable models
like topic models.)</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, f<span class="sc">$</span>model[, <span class="sc">-</span><span class="dv">1</span>]) <span class="co"># note, you have to add 1&#39;s for the intercept and</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>                             <span class="co"># I&#39;m removing the first column of f$model as it</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>                             <span class="co"># is the outcome we are predicting</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x) <span class="co"># x needs to be a matrix, not a data.frame or tibble for now</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">matrix</span>(f<span class="sc">$</span>coefficients, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="co"># w also has to be a matrix</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># this calculates yhat as the dot product x %*% w</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>r2_mv2 <span class="ot">&lt;-</span> <span class="fu">calc_rsquared</span>(<span class="at">y =</span> mtcars<span class="sc">$</span>mpg, </span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>                        <span class="at">yhat =</span> <span class="fu">list</span>(<span class="at">x =</span> x,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>                                    <span class="at">w =</span> w))</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>r2_mv2</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">#&gt; [1] 0.8486348</span></span></code></pre></div>
<p>Calculating R-squared this way does lead to a tiny difference in
calculation due to numeric precision.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>r2_mv2 <span class="sc">==</span> r2_lm</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>However, the difference is tiny. Below demonstrates that they are the
same up to 14 decimal places in this example.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">round</span>(r2_mv2, <span class="dv">14</span>) <span class="sc">==</span> <span class="fu">round</span>(r2_lm, <span class="dv">14</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div id="multivariate-r-squared" class="section level1">
<h1>Multivariate R-squared</h1>
<div id="multivariate-prediction" class="section level2">
<h2>Multivariate prediction</h2>
<div id="a-silly-example-to-prove-a-point" class="section level3">
<h3>A silly example to prove a point</h3>
<p>Below, just to show you I’m not blowing smoke, is a silly example
that demonstrates that you don’t get any crazy results just because your
outcome is a matrix. If we make the columns of <span class="math inline">\(y\)</span> the same values (and ditto for <span class="math inline">\(\hat{y}\)</span>), you actually get the same
R-squared as above.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">calc_rsquared</span>(<span class="at">y =</span> <span class="fu">cbind</span>(mtcars<span class="sc">$</span>mpg, mtcars<span class="sc">$</span>mpg),</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>              <span class="at">yhat =</span> <span class="fu">cbind</span>(f<span class="sc">$</span>fitted.values, f<span class="sc">$</span>fitted.values))</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#&gt; [1] 0.8486348</span></span></code></pre></div>
<p>Same as above, no?</p>
</div>
<div id="a-more-realistic-example" class="section level3">
<h3>A more realistic example</h3>
<p>Here’s a more realistic example. Say you’ve got a neural net that is
predicting two variables at once.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">library</span>(nnet)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co"># let&#39;s generate some synthetic data</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">666</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co"># Some continuous variables</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">10000</span>, <span class="at">mean =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">10000</span>, <span class="at">mean =</span> <span class="fl">1.5</span>, <span class="at">sd =</span> <span class="fl">2.5</span>)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>x3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">10000</span>, <span class="at">mean =</span> .<span class="dv">6</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co"># linear combinations used to generate outcomes with logit functions</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1.2</span> <span class="sc">*</span> x1 <span class="sc">+</span> <span class="fl">4.5</span> <span class="sc">*</span> x2 <span class="sc">-</span> <span class="fl">2.8</span> <span class="sc">*</span> x3 </span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>z2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">2.8</span> <span class="sc">*</span> x1 <span class="sc">-</span> <span class="fl">1.2</span> <span class="sc">*</span> x2 <span class="sc">+</span> <span class="fl">4.5</span> <span class="sc">*</span> x3 </span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="at">prob =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>z1)))</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>y2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="at">prob =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>z2)))</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co"># fit a multinomial model using a 1-layer neural net with 10 nodes</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>f_mv <span class="ot">&lt;-</span> <span class="fu">nnet</span>(<span class="fu">cbind</span>(y1, y2) <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3, </span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="co">#&gt; # weights:  62</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="co">#&gt; initial  value 6406.585738 </span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="co">#&gt; iter  10 value 3246.812009</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co">#&gt; iter  20 value 1446.678774</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a><span class="co">#&gt; iter  30 value 1060.315445</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a><span class="co">#&gt; iter  40 value 1004.698287</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a><span class="co">#&gt; iter  50 value 961.043723</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a><span class="co">#&gt; iter  60 value 932.089225</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a><span class="co">#&gt; iter  70 value 907.861456</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a><span class="co">#&gt; iter  80 value 901.751981</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="co">#&gt; iter  90 value 899.029455</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a><span class="co">#&gt; iter 100 value 896.508832</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="co">#&gt; final  value 896.508832 </span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="co">#&gt; stopped after 100 iterations</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>yhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(f_mv, <span class="fu">data.frame</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, <span class="at">x3 =</span> x3), <span class="at">type =</span> <span class="st">&quot;raw&quot;</span>)</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a><span class="co"># and now calculate r-squared</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a><span class="fu">calc_rsquared</span>(<span class="at">y =</span> <span class="fu">cbind</span>(y1, y2), <span class="at">yhat =</span> yhat)</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a><span class="co">#&gt; [1] 0.8094835</span></span></code></pre></div>
</div>
</div>
<div id="probabilistic-topic-modeling" class="section level2">
<h2>Probabilistic topic modeling</h2>
<p><a href="https://arxiv.org/abs/1911.11061">The paper</a> (as of this
writing still in progress) that derives the multivariate R-squared is
focused on probabilistic topic modeling. Here’s an example using Latent
Dirichlet Allocation.</p>
<p>Below are preliminaries of loading data and getting the model.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">library</span>(textmineR)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; Loading required package: Matrix</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt; Attaching package: &#39;textmineR&#39;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#&gt; The following object is masked from &#39;package:Matrix&#39;:</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt;     update</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">#&gt; The following object is masked from &#39;package:stats&#39;:</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co">#&gt;     update</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co">#&gt; Attaching package: &#39;dplyr&#39;</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="co">#&gt; The following objects are masked from &#39;package:stats&#39;:</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="co">#&gt;     filter, lag</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="co">#&gt; The following objects are masked from &#39;package:base&#39;:</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a><span class="co"># load documents in a data frame</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>docs <span class="ot">&lt;-</span> nih_sample </span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="co"># tokenize using tidytext&#39;s unnest_tokens</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>tidy_docs <span class="ot">&lt;-</span> docs <span class="sc">%&gt;%</span> </span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  <span class="fu">select</span>(APPLICATION_ID, ABSTRACT_TEXT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>  <span class="fu">unnest_tokens</span>(<span class="at">output =</span> word, </span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>                <span class="at">input =</span> ABSTRACT_TEXT,</span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>                <span class="at">stopwords =</span> stop_words<span class="sc">$</span>word,</span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>                <span class="at">token =</span> <span class="st">&quot;ngrams&quot;</span>,</span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>                <span class="at">n_min =</span> <span class="dv">1</span>, <span class="at">n =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>  <span class="fu">count</span>(APPLICATION_ID, word) <span class="sc">%&gt;%</span> </span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>  <span class="fu">filter</span>(n<span class="sc">&gt;</span><span class="dv">1</span>) <span class="co">#Filtering for words/bigrams per document, rather than per corpus</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>tidy_docs <span class="ot">&lt;-</span> tidy_docs <span class="sc">%&gt;%</span> <span class="co"># filter words that are just numbers</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">str_detect</span>(tidy_docs<span class="sc">$</span>word, <span class="st">&quot;^[0-9]+$&quot;</span>))</span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a><span class="co"># turn a tidy tbl into a sparse dgCMatrix for use in textmineR</span></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>dtm <span class="ot">&lt;-</span> tidy_docs <span class="sc">%&gt;%</span> </span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>  <span class="fu">cast_sparse</span>(APPLICATION_ID, word, n)</span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a><span class="co"># create a topic model</span></span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>lda <span class="ot">&lt;-</span> <span class="fu">FitLdaModel</span>(<span class="at">dtm =</span> dtm, </span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>                   <span class="at">k =</span> <span class="dv">20</span>,</span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a>                   <span class="at">iterations =</span> <span class="dv">200</span>,</span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a>                   <span class="at">burnin =</span> <span class="dv">175</span>)</span></code></pre></div>
<p>The paper notes that for a probabilistic topic model, <span class="math inline">\(\hat{y} = \vec{n} \odot \Theta \cdot
\Phi\)</span>, where <span class="math inline">\(\vec{n}\)</span> is a
vector of document lengths, <span class="math inline">\(\odot\)</span>
is elementwise multiplication, <span class="math inline">\(\Theta\)</span> is a matrix of topic distributions
over documents, and <span class="math inline">\(\Phi\)</span> is a
matrix of token distributions over topics.</p>
<p>Doing this multiplication explicitly in R could lead you to run out
of RAM for a decently-sized corpus. (This toy example won’t.) Luckily,
we can use the ability to pass a list <code>x</code> and <code>w</code>
to <code>calc_rsquared</code> to do that multiplication more
efficiently. In that case, we set <code>x</code> <span class="math inline">\(= \vec{n}\odot\Theta\)</span> and <code>w</code>
<span class="math inline">\(= \Phi\)</span>.</p>
<p>(Note that you can pass a sparse <code>dgCMatrix</code> from the
<code>Matrix</code> or something coercible to one directly to
<code>calc_rsquared</code>.)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>r2_lda <span class="ot">&lt;-</span> <span class="fu">calc_rsquared</span>(<span class="at">y =</span> dtm, </span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>                        <span class="at">yhat =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">rowSums</span>(dtm) <span class="sc">*</span> lda<span class="sc">$</span>theta, <span class="at">w =</span> lda<span class="sc">$</span>phi))</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>r2_lda</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#&gt; [1] 0.2885575</span></span></code></pre></div>
</div>
<div id="latent-semantic-analysis-topic-modeling" class="section level2">
<h2>Latent semantic analysis topic modeling</h2>
<p>Latent semantic analysis (LSA) uses a single value decomposition of a
document term matrix as a non-probabilistic topic model.</p>
<p>Note the example below doesn’t use <a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">TF-IDF</a> even
though most folks recommend you do. For a more thorough example of LSA
(and LDA) see <code>textmineR</code>’s <a href="https://www.rtextminer.com/articles/c_topic_modeling.html">vignette
on topic modeling</a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>lsa <span class="ot">&lt;-</span> <span class="fu">FitLsaModel</span>(<span class="at">dtm =</span> dtm, <span class="at">k =</span> <span class="dv">20</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>r2_lsa <span class="ot">&lt;-</span> <span class="fu">calc_rsquared</span>(<span class="at">y =</span> dtm,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>                        <span class="at">yhat =</span> <span class="fu">list</span>(<span class="at">x =</span> lsa<span class="sc">$</span>theta <span class="sc">%*%</span> <span class="fu">diag</span>(lsa<span class="sc">$</span>sv), <span class="at">w =</span> lsa<span class="sc">$</span>phi))</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>r2_lsa</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co">#&gt; [1] 0.4539497</span></span></code></pre></div>
</div>
</div>
<div id="parallelizationdistributed-computing-for-large-data-sets" class="section level1">
<h1>Parallelization/distributed computing for large data sets</h1>
<p>You say you have BIG DATA?!?! Below is an example of how to chop up a
calculation and have r-squared built in parallel in a distributed
setting. <code>mvrsquared</code> has a parallel back end using <a href="https://CRAN.R-project.org/package=RcppThread"><code>RcppThread</code></a>
and controlled by the <code>threads</code> argument. However, if that
isn’t enough, you can bring your own distributed parallel framework. The
example below uses <code>parallel::mclapply</code> which will not
parallelize on Windows, but R has other options.</p>
<p><code>mvrsquared</code> has the option to return only the sums of
squares (specifically SSE and SST). You can calculate these in
parallel/distributed and combine them by adding post-hoc. (That’s a
little algorithm called “map-reduce” for those in the know.) Once
combined, you can calculate R-squared yourself with the canonical
formula <span class="math inline">\(1 - \frac{SSE}{SST}\)</span>.</p>
<p>Note: You <strong>must</strong> calculate the mean of your outcome,
<span class="math inline">\(\bar{y}\)</span>, first and hand it off to
<code>calc_rsquared</code>. Otherwise, your calculations for SST on a
given core will be based only on the observations sent to that core, not
the whole data set. (If you do this, <code>calc_rsquared</code> will
give you a WARNING.)</p>
<p>Below is a toy example using <code>parallel::mclapply</code> to run
parallel computations calculating R-squared for our LDA model, above.
(Yes, this is overkill for our toy problem and it will actually be
slower due to overhead. But imagine the calculations for a corpus of ~1
million documents with hundreds-of-thousands or millions of unique
tokens.)</p>
<p>Because the below example uses parallel execution, which can be
tricky when working with CRAN, I’m not actually evaluating it in this
vignette. However, you can run the code yourself.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>batches <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(<span class="at">X =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(dtm), <span class="at">by =</span> batch_size),</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(b){</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>                      </span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>                      <span class="co"># rows to select on</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>                      rows <span class="ot">&lt;-</span> b<span class="sc">:</span><span class="fu">min</span>(b <span class="sc">+</span> batch_size <span class="sc">-</span> <span class="dv">1</span>, <span class="fu">nrow</span>(dtm))</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>                      </span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>                      <span class="co"># rows of the dtm</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>                      y_batch <span class="ot">&lt;-</span> dtm[rows, ]</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>                      </span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>                      <span class="co"># rows of theta multiplied by document length</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>                      x_batch <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(y_batch) <span class="sc">*</span> lda<span class="sc">$</span>theta[rows, ]</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>                      </span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>                      <span class="fu">list</span>(<span class="at">y =</span> y_batch,</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>                           <span class="at">x =</span> x_batch)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>                    }, <span class="at">mc.cores =</span> <span class="dv">2</span>)</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="co"># calculate ybar for the data</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="co"># in this case, lazily doing colMeans, but you could divide this problem up too</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>ybar <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(dtm)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a><span class="co"># MAP: calculate sums of squares</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(<span class="at">X =</span> batches,</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>               <span class="at">FUN =</span> <span class="cf">function</span>(batch){</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>                 <span class="fu">calc_rsquared</span>(<span class="at">y =</span> batch<span class="sc">$</span>y,</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>                               <span class="at">yhat =</span> <span class="fu">list</span>(<span class="at">x =</span> batch<span class="sc">$</span>x, <span class="at">w =</span> lda<span class="sc">$</span>phi),</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>                               <span class="at">ybar =</span> ybar,</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>                               <span class="at">return_ss_only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>               }, <span class="at">mc.cores =</span> <span class="dv">2</span>)</span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="co"># REDUCE: get SST and SSE by summation</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, ss) <span class="sc">%&gt;%</span> <span class="fu">colSums</span>()</span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>r2_mapreduce <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> ss[<span class="st">&quot;sse&quot;</span>] <span class="sc">/</span> ss[<span class="st">&quot;sst&quot;</span>]</span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a><span class="co"># should be the same as above</span></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>r2_mapreduce</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
